# Quick Context for Claude

**Project**: Virtual Client - Social work training with AI simulations  
**Current Phase**: MVP - Minimum Viable Conversation  
**Language**: Python 3.12 with FastAPI  
**Database**: PostgreSQL (or SQLite for MVP week)  
**LLM**: Anthropic Claude (Haiku for testing, Sonnet for production)  
**Testing**: pytest  
**IDE**: PyCharm on Windows  

## 🎯 Current Task
MVP Week 1 Day 4-5: Streamlit Prototype - Part 5 of 10 Ready

**Testing Approach**: Minimal automated tests for MVP - focus on building working features for user feedback. One happy path test per part maximum.

**Day 3 Completed**: All 5 parts of Anthropic Integration complete ✅
**Day 4-5 Progress**: 
- Part 1 Completed ✅: MVP Setup & Basic Infrastructure
  - Created mvp/ directory with all files
  - Implemented comprehensive utils.py
  - Fixed auth models and SQL queries
  - Added 19 tests for utilities
- Part 2 Completed ✅: Teacher Interface - Client Form
  - Full client creation form with validation
  - Save functionality integrated with database
  - Display saved clients with expandable details
  - Added 13 tests (all passing)
- Part 3 Completed ✅: Teacher Interface - Test Conversation
  - Full chat interface with real-time messaging
  - Token counting and cost tracking
  - Session management (start/end conversations)
  - Fixed all AttributeError issues
  - Added 22 tests (all passing)
  - Environment configuration pattern implemented
- Part 4 Completed ✅: Teacher Interface - Metrics & History
  - Conversation history viewer with expandable details
  - 7 key metrics dashboard (costs, tokens, response times)
  - Export conversations as markdown
  - Added 18 tests (15 passing, 3 with minor issues)
- Part 5 Completed ✅: Student Interface - Client Selection
  - Client grid display with cards
  - Session detection (Start vs Continue)
  - Integration with existing services
  - Added 1 integration test (passing)
- Part 6 Completed ✅: Student Interface - Conversation
  - Full conversation interface with real-time updates
  - Session metrics (duration, tokens, cost)
  - Message history with proper formatting
  - End Session functionality
  - Added 1 comprehensive conversation flow test
- Part 7 Completed ✅: Admin Dashboard - Basic Metrics
  - Real-time metrics aggregation (active sessions, tokens today, cost today)
  - Session overview with active session details
  - Manual refresh functionality
  - Error handling for database issues
  - Added 1 integration test with 3 scenarios
- Part 8 Completed ✅: Admin Dashboard - Enhanced Monitoring
  - Auto-refresh functionality (30-second intervals)
  - Usage graphs showing 24-hour token/cost trends
  - Service health monitoring (API + database)
  - Error log viewer with severity categorization
  - Added 1 comprehensive integration test

**Ready to Start**: Part 9 - Polish & Integration Testing
- Add error handling to all interfaces
- Improve UI styling and layout 
- Add loading states
- Test all three interfaces together
- ~1 hour estimated

**Key Implementation Notes from Part 6**:
- Successfully reused conversation patterns from teacher interface
- Proper mocking pattern for Anthropic service: patch `backend.services.conversation_service.anthropic_service`
- Use `side_effect` for multiple mock responses in sequence
- Session duration calculated as: `datetime.now() - st.session_state.conversation_start_time`
- Always check exact field names in models rather than guessing

**Implementation Order**:
1. Part 1: MVP Setup & Basic Infrastructure ✅
2. Part 2: Teacher Interface - Client Form ✅
3. Part 3: Teacher Interface - Test Conversation ✅
4. Part 4: Teacher Interface - Metrics & History ✅
5. Part 5: Student Interface - Client Selection ✅
6. Part 6: Student Interface - Conversation ← **NEXT**
7. Part 7: Admin Dashboard - Basic Metrics
8. Part 8: Admin Dashboard - Enhanced Monitoring
9. Part 9: Polish & Integration Testing
10. Part 10: Documentation & Handoff

**Total Time**: ~8-10 hours across multiple sessions

**Key Features from Day 3**:
- Circuit breaker for API protection
- Cost tracking with alerts ($0.10/$0.50/$10)
- Fallback responses for outages
- Service health monitoring
- All integrated and tested

**Day 1-2 Completed**: All 6 parts of Session & Message Models complete
- Session model simplified for MVP
- Message model with efficient storage
- Session service with full CRUD operations
- Message operations with automatic sequencing
- Token counting utility integrated

**Day 3 Progress - COMPLETE**:
- Part 1 Completed: Anthropic API Setup ✅
- Part 2 Completed: Prompt Generation Service ✅
- Part 3 Completed: Conversation Handler Service ✅
- Part 4 Completed: Rate Limiting ✅
- Part 5 Completed: Error Handling & Robustness ✅
  - Circuit breaker pattern for failure prevention
  - Comprehensive cost tracking and alerts
  - Fallback response system
  - Service health monitoring
- 600 total tests (597 passing, 3 skipped)

## ⚡ Critical MVP Patterns
- Messages in separate table (not JSON) for scale
- Token counting from day 1
- Simple session model (enhance later)
- Streamlit for rapid iteration
- Cost tracking built-in
- Focus on conversation quality

## 🔑 Existing Services to Reuse
```python
# From client_service
get(db, client_id)  # Get client for conversation
get_teacher_clients(db, teacher_id)  # List for testing
create_client_for_teacher(db, client_data, teacher_id)  # Create new client

# From conversation_service
start_conversation(student_id, client_id) -> Session
send_message(session_id, content, user) -> Message
end_conversation(session_id, user) -> Session

# From mvp.utils (implemented)
get_mock_teacher() -> TeacherAuth(id="teacher-1", teacher_id="teacher-1")
get_mock_student() -> StudentAuth(id="student-1", student_id="student-1")
get_database_connection() -> Session
setup_page_config(title, icon, layout)
show_error_message(msg), show_success_message(msg), show_info_message(msg)
format_cost(cost), format_tokens(tokens)
render_chat_message(role, content, tokens)
```

## 📁 Project Structure
```
C:\Users\engbrech\Python\virtual_client\
├── backend/
│   ├── api/           # Existing endpoints
│   ├── services/      # Including session_service.py, conversation_service.py
│   └── models/        # Including session.py, message.py
├── mvp/               # ✅ Streamlit prototype (created)
│   ├── __init__.py       # ✅ Package init
│   ├── utils.py          # ✅ Shared utilities (complete)
│   ├── test_streamlit.py # ✅ Setup verification
│   ├── teacher_test.py   # ✅ Teacher interface (Part 2 complete, Part 3 ready)
│   ├── student_practice.py # Student interface (skeleton)
│   └── admin_monitor.py  # Admin dashboard (skeleton)
└── tests/
    ├── unit/
    │   ├── test_mvp_utils.py  # ✅ 11 tests for utilities
    │   └── test_teacher_interface_logic.py  # ✅ 6 tests for business logic
    └── integration/
        ├── test_mvp_setup.py  # ✅ 8 tests for setup
        └── test_teacher_interface_integration.py  # ✅ 7 tests for teacher interface
```

## 🚀 Quick Start Commands
```bash
# Start API server (existing)
python start_server.py

# Run Streamlit apps (new) - LOCAL DEVELOPMENT
streamlit run mvp/teacher_test.py
streamlit run mvp/student_practice.py

# Run existing tests
python run_tests.py

# Deploy to Railway (when ready for external testing)
railway up
```

## 📋 MVP Success Checklist
1. [ ] 10+ test conversations
2. [ ] <$0.01 per conversation
3. [ ] 5+ teacher feedback
4. [ ] Conversation quality validated
5. [ ] Technical feasibility proven
6. [ ] Clear Phase 2 requirements

## ⚠️ MVP Constraints
- One client at a time for testing
- No rubric evaluation yet
- Basic UI (Streamlit)
- Manual feedback collection
- Limited to test users
- Local development first (deploy to Railway when ready)

---
*For detailed context see PROJECT_ROADMAP.md | For patterns see PATTERNS.md*